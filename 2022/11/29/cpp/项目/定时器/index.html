<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" href="https://aristotlednzk.github.io.com/rss.xml"><link rel="alternate" type="application/atom+xml" href="https://aristotlednzk.github.io.com/atom.xml"><link rel="alternate" type="application/json" href="https://aristotlednzk.github.io.com/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="C++,项目"><link rel="canonical" href="https://aristotlednzk.github.io.com/2022/11/29/cpp/%E9%A1%B9%E7%9B%AE/%E5%AE%9A%E6%97%B6%E5%99%A8/"><title>定时器 - 项目 - C++ | Sean Barrett = = 远行者回忆录——人类往事</title><meta name="generator" content="Hexo 6.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">定时器</h1><div class="meta"><span class="item" title="创建时间：2022-11-29 13:28:41"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2022-11-29T13:28:41+08:00">2022-11-29</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>5.5k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>5 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Sean Barrett</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gicli9lfebj20zk0m84qp.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gipex2cdtbj20zk0m8x6p.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gipeun65urj20zk0m81ii.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gipey0a334j20zk0m8qpt.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1giclxp31goj20zk0m8qv5.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1giciszlczyj20zk0m816d.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/cpp/" itemprop="item" rel="index" title="分类于 C++"><span itemprop="name">C++</span></a><meta itemprop="position" content="1"></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/cpp/%E9%A1%B9%E7%9B%AE/" itemprop="item" rel="index" title="分类于 项目"><span itemprop="name">项目</span></a><meta itemprop="position" content="2"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://aristotlednzk.github.io.com/2022/11/29/cpp/%E9%A1%B9%E7%9B%AE/%E5%AE%9A%E6%97%B6%E5%99%A8/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="Sean Barrett"><meta itemprop="description" content="远行者回忆录——人类往事, 思及我域"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content=""></span><div class="body md" itemprop="articleBody"><p><span class="exturl" data-url="aHR0cHM6Ly9tcC53ZWl4aW4ucXEuY29tL3MvbW1YTHFoX055d2hCWEp2STQ1aGNoQQ==">https://mp.weixin.qq.com/s/mmXLqh_NywhBXJvI45hchA</span></p><h2 id="基础知识"><a class="anchor" href="#基础知识">#</a> 基础知识</h2><ol><li><code>非活跃</code> ，是指客户端（这里是浏览器）与服务器端建立连接后，<strong>长时间不交换数据</strong>，一直占用服务器端的文件描述符，导致连接资源的浪费。</li><li>定时事件：是指固定一段时间之后触发某段代码，由该段代码处理一个事件，如从内核事件表删除事件，并关闭文件描述符，释放连接资源。</li><li><code>定时器</code> ，是指利用结构体或其他形式，** 将多种定时事件进行封装起来。** 具体的，这里只涉及一种定时事件，即定期检测非活跃连接，这里将该定时事件与连接资源封装为一个结构体定时器。</li><li><code>定时器容器</code> ，是指使用某种容器类数据结构，将上述多个定时器组合起来，便于对定时事件统一管理。具体的，项目中使用升序链表将所有定时器串联组织起来。</li><li><strong>基础 API</strong>，描述 <code>sigaction</code> 结构体、 <code>sigaction</code> 函数、 <code>sigfillset</code> 函数、 <code>SIGALRM</code> 信号、 <code>SIGTERM</code> 信号、 <code>alarm</code> 函数、 <code>socketpair</code> 函数、 <code>send</code> 函数。</li></ol><h4 id="alarm函数"><a class="anchor" href="#alarm函数">#</a> <strong>alarm 函数</strong></h4><pre><code class="language-C++">#include &lt;unistd.h&gt;;
unsigned int alarm(unsigned int seconds);
</code></pre><p>设置信号传送闹钟，即用来设置信号 SIGALRM 在经过参数 seconds 秒数后发送给目前的进程。如果未设置信号 SIGALRM 的处理函数，那么 alarm () 默认处理终止进程.</p><h4 id="sigfillset函数"><a class="anchor" href="#sigfillset函数">#</a> <strong>sigfillset 函数</strong></h4><pre><code class="language-C++">1#include &lt;signal.h&gt;
2int sigfillset(sigset_t *set);
</code></pre><p>用来将参数<strong> set 信号集初始化</strong>，然后<strong>把所有的信号加入到此信号集</strong>里。</p><h4 id="sigalrm-sigterm信号"><a class="anchor" href="#sigalrm-sigterm信号">#</a> <strong>SIGALRM、SIGTERM 信号</strong></h4><pre><code class="language-C++">1#define SIGALRM  14     //**由alarm系统调用产生timer时钟信号**
2#define SIGTERM  15     //终端发送的终止信号
</code></pre><h4 id="alarm函数-2"><a class="anchor" href="#alarm函数-2">#</a> <strong>alarm 函数</strong></h4><pre><code class="language-C++">1#include &lt;unistd.h&gt;;
2unsigned int alarm(unsigned int seconds);
</code></pre><p>设置信号传送闹钟，即用来<strong>设置信号 SIGALRM 在经过参数 seconds 秒数后发送给目前的进程</strong>。如果未设置信号 SIGALRM 的处理函数，那么 alarm () 默认处理终止进程.</p><h4 id="socketpair函数"><a class="anchor" href="#socketpair函数">#</a> <strong>socketpair 函数</strong></h4><p>在 linux 下，使用 socketpair 函数能够<strong>创建一对套接字进行通信，项目中使用管道通信</strong>。</p><pre><code class="language-C++">#include &lt;sys/types.h&gt;
#include &lt;sys/socket.h&gt;
int socketpair(int domain, int type, int protocol, int sv[2]);
</code></pre><ul><li>domain 表示协议族，PF_UNIX 或者 AF_UNIX</li><li>type 表示协议，可以是 SOCK_STREAM 或者 SOCK_DGRAM，SOCK_STREAM 基于 TCP，SOCK_DGRAM 基于 UDP</li><li>protocol 表示类型，只能为 0</li><li>sv [2] 表示<strong>套节字柄对，该两个句柄作用相同，均能进行读写双向操作</strong></li><li>返回结果， 0 为创建成功，-1 为创建失败</li></ul><h4 id="send函数"><a class="anchor" href="#send函数">#</a> <strong>send 函数</strong></h4><pre><code class="language-C++">#include &lt;sys/types.h&gt;
#include &lt;sys/socket.h&gt;
ssize_t send(int sockfd, const void *buf, size_t len, int flags);
</code></pre><p>当套接字发送缓冲区变满时，send 通常会阻塞，除非套接字设置为非阻塞模式，当缓冲区变满时，返回 EAGAIN 或者 EWOULDBLOCK 错误，此时可以调用 select 函数来监视何时可以发送数据。</p><hr><h3 id="整体流程"><a class="anchor" href="#整体流程">#</a> 整体流程</h3><pre><code>   如果某一用户`connect()`到服务器之后，长时间不交换数据，一直占用服务器端的文件描述符，导致连接资源的浪费。这时候就应该利用定时器把这些超时的非活动连接释放掉，关闭其占用的文件描述符。这种情况也很常见，当你登录一个网站后长时间没有操作该网站的网页，再次访问的时候你会发现需要重新登录。

   本项目中，**服务器主循环为每一个连接创建一个定时器**，并对每个连接进行定时。另外，利用**升序时间链表容器**将所有定时器**串联**起来，若主循环接收到定时通知，则在链表中依次执行定时任务。
</code></pre><blockquote><p>项目中使用的是 ** <code>SIGALRM信号</code> <strong><em>* 来实现定时器 *</em>，利用</strong> <code>alarm</code> <em><strong>* 函数周期性的触发 *</strong></em> <code>SIGALRM</code> <strong><em>* 信号 *</em>，*<em> 信号处理函数利用管道通知主循环 *</em>，当主循环在读端 <code>pipefd[0]</code> 读到这个信号的的时候，就会将 <code>timeout</code> 变量置为 <code>true</code> 并跳出循环，让 <code>timer_handler()</code> 函数取出来定时器容器上的到期任务，该定时器容器是通过升序链表来实现的，*<em> 从头到尾对检查任务是否超时，若超时则调用定时器的回调函数 *</em></strong> <code>cb_func()</code> <em><strong>*，关闭该 socket 连接，并删除其对应的定时器 *</strong></em> <code>del_timer</code> **，释放所占用的资源。</p></blockquote><ul><li>执行自定义的信号函数 addsig：其中定义了信号捕获函数（当捕获到 SIGALRM 和 SIGTERM 信号则执行信号处理函数：传递给主循环的信号值</li></ul><p><img data-src="/2022/11/29/cpp/%E9%A1%B9%E7%9B%AE/%E5%AE%9A%E6%97%B6%E5%99%A8/%E5%AE%9A%E6%97%B6%E5%99%A8.png" title="定时器"></p><p><code>alarm</code> 函数会定期触发 <code>SIGALRM</code> 信号，这个信号交由 <code>sig_handler</code> 来处理，每当监测到有这个信号的时候，都会将这个信号写到 <code>pipefd[1]</code> 里面，传递给主循环：</p><p><strong>定时器优化</strong>这个基于升序双向链表实现的定时器存在着其固有缺点：</p><ul><li>每次遍历添加和修改定时器的效率偏低 (O (n))，使用<strong>最小堆结构可以降低时间复杂度降至 (O (logn))。</strong></li><li>每次以固定的时间间隔触发 <code>SIGALRM</code> 信号，调用 <code>tick</code> 函数处理超时连接会造成一定的触发浪费，举个例子，若当前的 <code>TIMESLOT=5</code> ，即每隔 5ms 触发一次 <code>SIGALRM</code> ，跳出循环执行 <code>tick</code> 函数，这时如果当前即将超时的任务距离现在还有 <code>20ms</code> ，那么在这个期间， <code>SIGALRM</code> 信号被触发了 4 次， <code>tick</code> 函数也被执行了 4 次，可是在这 4 次中，前三次触发都是无意义的。对此，我们可以动态的设置 <code>TIMESLOT</code> 的值，每次将其值设置为<strong>当前最先超时的定时器与当前时间的时间差</strong>，这样每次调用 <code>tick</code> 函数，超时时间最小的定时器必然到期，并被处理，然后在从时间堆中取一个最先超时的定时器的时间与当前时间做时间差，更新 <code>TIMESLOT</code> 的值。</li></ul><h4 id="定时器处理非活动连接"><a class="anchor" href="#定时器处理非活动连接">#</a> 定时器处理非活动连接</h4><p>由于非活跃连接占用了连接资源，严重影响服务器的性能，通过实现一个服务器定时器，处理这种非活跃连接，释放连接资源。利用 alarm 函数周期性地触发 SIGALRM 信号，该信号的信号处理函数利用管道通知主循环执行定时器链表上的定时任务.</p><ul><li><strong>统一事件源</strong></li><li>基于升序链表的定时器</li><li>处理非活动连接</li></ul><p>sort_timer_lst 是一个升序链表，其核心函数 tick 每隔一段时间就执行一次，以检测并处理到期的任务。判断定时器到期的依据是定时器的 expire 值小于当前的系统时间。</p><h4 id="处理非活跃连接"><a class="anchor" href="#处理非活跃连接">#</a> 处理非活跃连接</h4><p>在应用层实现 KEEPALIVE 机制，以管理所有长期处于非活跃状态的连接。</p><p>利用 alarm 函数周期性地触发 SIGALRM 信号，该信号的信号处理函数利用管道通知主循环执行定时器链表上的定时任务→<strong>关闭非活跃连接</strong></p><h4 id="信号通知逻辑"><a class="anchor" href="#信号通知逻辑">#</a> <strong>信号通知逻辑</strong></h4><ul><li><p>创建管道，其中管道写端写入信号值，<strong>管道读端通过 I/O 复用系统监测读事件</strong></p></li><li><p>设置</p><p>信号处理函数</p><p>SIGALRM（时间到了触发）和 SIGTERM（kill 会触发，Ctrl+C）</p><ul><li>通过 struct sigaction 结构体和 sigaction 函数注册信号捕捉函数</li><li>在结构体的 handler 参数设置信号处理函数，具体的，从管道写端写入信号的名字</li></ul></li><li><p>利用 I/O 复用系统监听管道读端文件描述符的可读事件</p></li><li><p>信息值传递给主循环，主循环再根据接收到的信号值执行目标信号对应的逻辑代码</p></li></ul><h2 id="基于升序链表的定时器"><a class="anchor" href="#基于升序链表的定时器">#</a> 基于升序链表的定时器</h2><p>定时器至少包含：超时时间和任务回调函数 使用链表作为容器串联所有定时器，则每个定时器还要包含下一个和上一个定时器的指针成员。</p><hr><p><code>Linux</code> 下提供了三种定时的方法:</p><ul><li>socket 选项 SO_RECVTIMEO 和 SO_SNDTIMEO</li><li>SIGALRM 信号</li><li>I/O 复用系统调用的超时参数</li></ul><p>项目中使用的是 <code>SIGALRM</code> 信号：</p><p>具体的，利用 <code>alarm</code> 函数周期性地触发 <code>SIGALRM</code> 信号，信号处理函数利用管道通知主循环，主循环接收到该信号后对升序链表上所有定时器进行处理，若该段时间内没有交换数据，则将该连接关闭，释放所占用的资源。</p><p>从上面的简要描述中，可以看出定时器处理非活动连接模块，主要分为两部分，其一为定时方法与信号通知流程，其二为定时器及其容器设计与定时任务的处理。</p><h3 id="信号通知流程"><a class="anchor" href="#信号通知流程">#</a> 信号通知流程</h3><p>介绍<strong>统一事件源</strong>和信号处理机制。</p><p>Linux 下的<strong>信号采用的异步处理机制</strong>，信号处理函数和当前进程是两条不同的执行路线。具体的，当进程收到信号时，<strong>操作系统会中断进程当前的正常流程</strong>，转而进入<strong>信号处理函数</strong>执行操作，完成后再返回中断的地方继续执行。</p><p><strong>为避免信号竞态现象发生，信号处理期间系统不会再次触发它</strong>。所以，为确保该信号不被屏蔽太久，信号处理函数需要尽可能快地执行完毕。</p><p>一般的信号处理函数需要处理该信号对应的逻辑，当该逻辑比较复杂时，信号处理函数执行时间过长，会导致信号屏蔽太久。</p><p>这里的解决方案是，信号处理函数仅仅发送信号通知程序主循环，将信号对应的处理逻辑放在程序主循环中，由主循环执行信号对应的逻辑代码。</p><h4 id="统一事件源"><a class="anchor" href="#统一事件源">#</a> <strong>统一事件源</strong></h4><p>统一事件源，是指将<strong>信号事件与其他事件一样</strong>被处理。</p><p>具体的，信号处理函数使用管道将信号传递给主循环，信号处理函数往管道的写端写入信号值，主循环则从管道的读端读出信号值，<strong>使用 I/O 复用系统调用来监听管道读端的可读事件</strong>，这样<strong>信号事件与其他文件描述符都可以通过 epoll 来监测</strong>，从而实现统一处理。</p><h4 id="信号处理机制"><a class="anchor" href="#信号处理机制">#</a> <strong>信号处理机制</strong></h4><p>每个进程之中，都有存着一个表，里面存着每种信号所代表的含义，内核通过设置表项中每一个位来标识对应的信号类型。</p><p>.png)</p><ul><li>信号的接收<ul><li><strong>接收信号的任务是由内核代理</strong>的，当内核接收到信号后，会将其放到对应进程的<strong>信号队列</strong>中，同时<strong>向进程发送一个中断</strong>，使其陷入内核态。注意，此时信号还只是在队列中，对进程来说暂时是不知道有信号到来的。</li></ul></li><li>信号的检测<ul><li>进程从内核态返回到用户态前进行<strong>信号检测</strong></li><li>进程在内核态中，从睡眠状态被唤醒的时候进行信号检测</li><li>进程陷入内核态后，有两种场景会对信号进行检测：</li><li>当发现有新信号时，便会进入下一步，信号的处理。</li></ul></li><li>信号的处理</li><li>( <strong>内核</strong> ) 信号处理函数是运行在用户态的，调用处理函数前，内核会将<strong>当前内核栈的内容备份拷贝到用户栈上</strong>，并且修改指令寄存器（eip）将其指向信号处理函数。</li><li>( <strong>用户</strong> ) 接下来进程返回到用户态中，执行相应的信号处理函数。</li><li>( <strong>内核</strong> ) 信号处理函数执行完成后，还需要返回内核态，检查是否还有其它信号未处理。</li><li>( <strong>用户</strong> ) 如果所有信号都处理完成，就会<strong>将内核栈恢复（从用户栈的备份拷贝回来）</strong>，同时恢复指令寄存器（eip）将其指向中断前的运行位置，最后回到用户态继续执行进程。</li></ul><p>至此，一个完整的信号处理流程便结束了，如果同时有多个信号到达，上面的处理流程会在第 2 步和第 3 步骤间重复进行。</p><h3 id="代码分析"><a class="anchor" href="#代码分析">#</a> 代码分析</h3><h4 id="信号处理函数"><a class="anchor" href="#信号处理函数">#</a> <strong>信号处理函数</strong></h4><p>自定义信号处理函数，创建 sigaction 结构体变量，设置信号函数。</p><ul><li>信号处理函数中仅仅通过管道发送信号值，不处理信号对应的逻辑，缩短异步执行时间，减少对主程序的影响。</li></ul><pre><code class="language-C++">1//信号处理函数 
2void sig_handler(int sig) 
3&#123; 
4    //为保证函数的可重入性，保留原来的errno 
5    //可重入性表示中断后再次进入该函数，环境变量与之前相同，不会丢失数据 6    int save_errno = errno; 
7    int msg = sig; 
8 
9    //将信号值从管道写端写入，传输字符类型，而非整型
10    send(pipefd[1], (char *)&amp;msg, 1, 0);
11
12    //将原来的errno赋值为当前的errno
13    errno = save_errno;
14&#125;
</code></pre><p>项目中设置信号函数，仅关注 SIGTERM 和 SIGALRM 两个信号。</p><pre><code class="language-C++">void Utils::addsig(int sig, void(handler)(int), bool restart)
&#123;//创建sigaction结构体变量
    struct sigaction sa;
    memset(&amp;sa, '\0', sizeof(sa));//memset是一个初始化函数，作用是将某一块内存中的全部设置为指定的值。
    //信号处理函数中仅仅发送信号值，不做对应信号处理逻辑
    sa.sa_handler = handler;
    if (restart)
    sa.sa_flags |= SA_RESTART;
    //将所有信号添加到信号集中
    sigfillset(&amp;sa.sa_mask);
    //执行sigaction函数
    assert(sigaction(sig, &amp;sa, NULL) != -1);
&#125;
</code></pre><hr><h1 id="小根堆定时器"><a class="anchor" href="#小根堆定时器">#</a> 小根堆定时器</h1><p>该定时器容器的思路是：将<strong>所有定时器中超时时间最小的一个定时器的超时值作为</strong>触发 <code>SIGALRM</code> 信号的时间间隔，这样，一旦心搏函数 tick 被调用，<strong>超时时间最小的定时器必然到期</strong>，我们就可以在 tick 函数中处理该定时器。然后，<strong>再从剩余的定时器中找到超时时间最小的一个，并将这段最小时间设置为下一次心搏间隔</strong>，如此反复，就实现了较为精确的定时。</p><p>Linux 下的 3 组 I/O 复用系统调用（select、poll、epoll）都带有定时参数，因此他们不仅能统一处理信号和 I/O 事件，也能统一处理定时事件。我们可以使用定时容器和 I/O 复用系统调用来共同实现定时器的触发。</p><p><strong>这三个系统调用都有一个 timeout 的参数，当发生 I/O 事件时，这三个系统调用将会返回； 当指定的时间到达时，如果没有 I/O 事件发生，这三个系统调用也会返回</strong></p><div class="tags"><a href="/tags/C/" rel="tag"><i class="ic i-tag"></i> C++</a> <a href="/tags/%E9%A1%B9%E7%9B%AE/" rel="tag"><i class="ic i-tag"></i> 项目</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2022-11-29 13:33:44" itemprop="dateModified" datetime="2022-11-29T13:33:44+08:00">2022-11-29</time> </span><span id="2022/11/29/cpp/项目/定时器/" class="item leancloud_visitors" data-flag-title="定时器" title="阅读次数"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">阅读次数</span> <span class="leancloud-visitors-count"></span> <span class="text">次</span></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/alipay.jpg" alt="Sean Barrett 支付宝"><p>支付宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>Sean Barrett <i class="ic i-at"><em>@</em></i></li><li class="link"><strong>本文链接：</strong> <a href="https://aristotlednzk.github.io.com/2022/11/29/cpp/%E9%A1%B9%E7%9B%AE/%E5%AE%9A%E6%97%B6%E5%99%A8/" title="定时器">https://aristotlednzk.github.io.com/2022/11/29/cpp/项目/定时器/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2022/11/15/cpp/%E9%A1%B9%E7%9B%AE/Linux%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%BC%80%E5%8F%91/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva1.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gipevo9j1jj20zk0m8e81.jpg" title="Linux多线程开发"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> Linux高性能服务器编程</span><h3>Linux多线程开发</h3></a></div><div class="item right"><a href="/2023/01/07/%E8%A8%80/%E4%B8%80%E4%BA%BA%E5%B1%B1%E6%B5%B7%EF%BC%8C%E7%BB%9D%E5%AD%A6%E6%97%A0%E5%BF%A7/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tva1.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gipeyvx1d4j20zk0m8hdt.jpg" title="一人山海，绝学无忧"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> 言</span><h3>一人山海，绝学无忧</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="toc-number">1.</span> <span class="toc-text">基础知识</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#alarm%E5%87%BD%E6%95%B0"><span class="toc-number">1.0.1.</span> <span class="toc-text">alarm 函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sigfillset%E5%87%BD%E6%95%B0"><span class="toc-number">1.0.2.</span> <span class="toc-text">sigfillset 函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sigalrm-sigterm%E4%BF%A1%E5%8F%B7"><span class="toc-number">1.0.3.</span> <span class="toc-text">SIGALRM、SIGTERM 信号</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#alarm%E5%87%BD%E6%95%B0-2"><span class="toc-number">1.0.4.</span> <span class="toc-text">alarm 函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#socketpair%E5%87%BD%E6%95%B0"><span class="toc-number">1.0.5.</span> <span class="toc-text">socketpair 函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#send%E5%87%BD%E6%95%B0"><span class="toc-number">1.0.6.</span> <span class="toc-text">send 函数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B"><span class="toc-number">1.1.</span> <span class="toc-text">整体流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E6%97%B6%E5%99%A8%E5%A4%84%E7%90%86%E9%9D%9E%E6%B4%BB%E5%8A%A8%E8%BF%9E%E6%8E%A5"><span class="toc-number">1.1.1.</span> <span class="toc-text">定时器处理非活动连接</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E9%9D%9E%E6%B4%BB%E8%B7%83%E8%BF%9E%E6%8E%A5"><span class="toc-number">1.1.2.</span> <span class="toc-text">处理非活跃连接</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%A1%E5%8F%B7%E9%80%9A%E7%9F%A5%E9%80%BB%E8%BE%91"><span class="toc-number">1.1.3.</span> <span class="toc-text">信号通知逻辑</span></a></li></ol></li></ol><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E5%8D%87%E5%BA%8F%E9%93%BE%E8%A1%A8%E7%9A%84%E5%AE%9A%E6%97%B6%E5%99%A8"><span class="toc-number">2.</span> <span class="toc-text">基于升序链表的定时器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%A1%E5%8F%B7%E9%80%9A%E7%9F%A5%E6%B5%81%E7%A8%8B"><span class="toc-number">2.1.</span> <span class="toc-text">信号通知流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%9F%E4%B8%80%E4%BA%8B%E4%BB%B6%E6%BA%90"><span class="toc-number">2.1.1.</span> <span class="toc-text">统一事件源</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%A1%E5%8F%B7%E5%A4%84%E7%90%86%E6%9C%BA%E5%88%B6"><span class="toc-number">2.1.2.</span> <span class="toc-text">信号处理机制</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">2.2.</span> <span class="toc-text">代码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%A1%E5%8F%B7%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0"><span class="toc-number">2.2.1.</span> <span class="toc-text">信号处理函数</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B0%8F%E6%A0%B9%E5%A0%86%E5%AE%9A%E6%97%B6%E5%99%A8"><span class="toc-number"></span> <span class="toc-text">小根堆定时器</span></a></li></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/2022/11/10/cpp/%E9%A1%B9%E7%9B%AE/Tinywebserver%E9%A1%B9%E7%9B%AE%E8%AE%B0%E5%BD%95/" rel="bookmark" title="Tinywebserver项目记录">Tinywebserver项目记录</a></li><li><a href="/2022/11/15/cpp/%E9%A1%B9%E7%9B%AE/IO%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8/" rel="bookmark" title="IO多路复用">IO多路复用</a></li><li><a href="/2022/11/15/cpp/%E9%A1%B9%E7%9B%AE/%E5%8D%8A%E5%90%8C%E6%AD%A5-%E5%8D%8A%E5%8F%8D%E5%BA%94%E5%A0%86%E7%BA%BF%E7%A8%8B%E6%B1%A0/" rel="bookmark" title="半同步/半反应堆线程池">半同步/半反应堆线程池</a></li><li class="active"><a href="/2022/11/29/cpp/%E9%A1%B9%E7%9B%AE/%E5%AE%9A%E6%97%B6%E5%99%A8/" rel="bookmark" title="定时器">定时器</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Sean Barrett" data-src="/images/avatar.jpg"><p class="name" itemprop="name">Sean Barrett</p><div class="description" itemprop="description">思及我域</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">23</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">16</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">17</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL0FyaXN0b3RsZUROWks=" title="https:&#x2F;&#x2F;github.com&#x2F;AristotleDNZK"><i class="ic i-github"></i></span> <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPTk0NTI2OTQy" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;94526942"><i class="ic i-cloud-music"></i></span> <a href="/jiang1302833@163.com" title="jiang1302833@163.com" class="item email"><i class="ic i-envelope"></i></a></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-clipboard"></i>书架</a><ul class="submenu"><li class="item"><a href="/books/deeplearning-books/" rel="section"><i class="ic i-fedora"></i>深度学习</a></li><li class="item"><a href="/books/philosophy-books/" rel="section"><i class="ic i-fedora"></i>哲学</a></li></ul></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>友链</a></li><li class="item"><a href="/links/" rel="section"><i class="ic i-magic"></i>链环</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2022/11/15/cpp/%E9%A1%B9%E7%9B%AE/Linux%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%BC%80%E5%8F%91/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2023/01/07/%E8%A8%80/%E4%B8%80%E4%BA%BA%E5%B1%B1%E6%B5%B7%EF%BC%8C%E7%BB%9D%E5%AD%A6%E6%97%A0%E5%BF%A7/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/GAN%E8%AF%BE%E9%A2%98/" title="分类于 GAN课题">GAN课题</a></div><span><a href="/2022/10/14/GAN%E8%AF%BE%E9%A2%98/%E7%9B%B8%E6%9C%BA%E6%89%8B%E7%9C%BC%E6%A0%87%E5%AE%9A/%E7%9B%B8%E6%9C%BA%E6%89%8B%E7%9C%BC%E6%A0%87%E5%AE%9A/" title="相机手眼标定">相机手眼标定</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/philosophy/" title="分类于 哲学社科">哲学社科</a> <i class="ic i-angle-right"></i> <a href="/categories/philosophy/%E8%A5%BF%E5%93%B2/" title="分类于 西哲">西哲</a></div><span><a href="/2022/10/12/philosophy/%E7%8E%B0%E8%B1%A1%E5%AD%A6-%E8%83%A1%E5%A1%9E%E5%B0%94/%E7%8E%B0%E8%B1%A1%E5%AD%A6-%E8%83%A1%E5%A1%9E%E5%B0%94/" title="现象学&#x2F;胡塞尔">现象学/胡塞尔</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E8%A8%80/" title="分类于 言">言</a></div><span><a href="/2022/10/12/%E8%BF%9C%E8%A1%8C%E8%80%85%E5%BC%80%E7%AF%87/%E8%BF%9C%E8%A1%8C%E8%80%85%E5%BC%80%E7%AF%87/" title="远行者开篇">远行者开篇</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/GAN%E8%AF%BE%E9%A2%98/" title="分类于 GAN课题">GAN课题</a> <i class="ic i-angle-right"></i> <a href="/categories/GAN%E8%AF%BE%E9%A2%98/%E7%94%9F%E6%88%90%E5%AF%B9%E6%8A%97%E7%BD%91%E7%BB%9C/" title="分类于 生成对抗网络">生成对抗网络</a></div><span><a href="/2022/10/12/GAN%E8%AF%BE%E9%A2%98/%E7%94%9F%E6%88%90%E5%AF%B9%E6%8A%97%E7%BD%91%E7%BB%9C/%E7%94%9F%E6%88%90%E5%AF%B9%E6%8A%97%E7%BD%91%E7%BB%9C/" title="生成对抗网络">生成对抗网络</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/cpp/" title="分类于 C++">C++</a> <i class="ic i-angle-right"></i> <a href="/categories/cpp/Linux%E9%AB%98%E6%80%A7%E8%83%BD%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BC%96%E7%A8%8B/" title="分类于 Linux高性能服务器编程">Linux高性能服务器编程</a></div><span><a href="/2022/11/15/cpp/%E9%A1%B9%E7%9B%AE/Linux%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%BC%80%E5%8F%91/" title="Linux多线程开发">Linux多线程开发</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/cpp/" title="分类于 C++">C++</a> <i class="ic i-angle-right"></i> <a href="/categories/cpp/Linux%E9%AB%98%E6%80%A7%E8%83%BD%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BC%96%E7%A8%8B/" title="分类于 Linux高性能服务器编程">Linux高性能服务器编程</a></div><span><a href="/2022/10/15/cpp/%E9%A1%B9%E7%9B%AE/Linux%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%EF%BC%9Asocket%E3%80%81IO%E5%A4%8D%E7%94%A8%E3%80%81epoll/" title="Linux网络编程：socket、IO复用、epoll">Linux网络编程：socket、IO复用、epoll</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E8%A8%80/" title="分类于 言">言</a></div><span><a href="/2022/10/18/%E8%A8%80/%E5%8F%B0%E9%A3%8E%E4%B8%8E%E7%A7%8B/" title="台风与秋">台风与秋</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E9%97%BB%E8%AF%B4/" title="分类于 阅读笔记">阅读笔记</a></div><span><a href="/2022/11/02/%E9%97%BB%E8%AF%B4/%E7%88%B1%E6%AC%B2%E4%B9%8B%E6%AD%BB/" title="爱欲之死">爱欲之死</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/philosophy/" title="分类于 哲学社科">哲学社科</a> <i class="ic i-angle-right"></i> <a href="/categories/philosophy/%E8%A5%BF%E5%93%B2/" title="分类于 西哲">西哲</a></div><span><a href="/2022/10/19/philosophy/%E4%BA%BA%E7%B1%BB%E7%9F%A5%E8%AF%86%E7%9A%84%E9%BB%98%E4%BC%9A%E7%BB%B4%E5%BA%A6/" title="人类知识的默会维度">人类知识的默会维度</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于 转码之路">转码之路</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" title="分类于 设计模式">设计模式</a></div><span><a href="/2022/11/15/computer-science/%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/" title="单例模式">单例模式</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2010 – <span itemprop="copyrightYear">2023</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Sean Barrett @ Sean Barrett</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">61k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">55 分钟</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2022/11/29/cpp/项目/定时器/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html>